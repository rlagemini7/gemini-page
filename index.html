<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gemini 이미지 생성기 (안드로이드 전용 + Gen-Z)</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --b:#ddd; }
  body{font-family:system-ui, Roboto, Arial; color:var(--fg); background:var(--bg); max-width:960px;margin:auto;padding:16px}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0}
  .btn, select, input[type="text"]{padding:.6rem .9rem;border:1px solid var(--b);border-radius:10px;background:#fff;color:#000}
  .btn{cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:default}
  #viewer{border:1px solid var(--b);border-radius:10px;min-height:240px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  #viewer img{max-width:100%;max-height:70vh}
  textarea{width:100%;font-family:monospace}
  #prompt{min-height:110px} #b64{min-height:140px} #raw{min-height:220px}
  #msg{white-space:pre-wrap;color:var(--muted)}
  .thumb{max-height:120px;border:1px solid var(--b);border-radius:8px}
  fieldset{border:1px solid var(--b);border-radius:12px;padding:10px}
  legend{padding:0 6px;color:#333}
  label.slab{display:flex;gap:8px;align-items:center;min-width:200px;justify-content:space-between}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
  .hint{font-size:.9rem;color:#666}
</style>
<body>
  <h2>Gemini 이미지 생성기</h2>

  <div class="row">
    <input id="endpoint" type="text" placeholder="https://<Cloud-Run-URL>" style="flex:2;min-width:240px">
    <input id="token" type="text" placeholder="(선택) Bearer 토큰" style="flex:1;min-width:160px">
  </div>

  <div class="row">
    <input id="file" type="file" accept="image/*" class="btn">
    <label class="slab"><input id="shrink" type="checkbox"> 512px로 축소</label>
    <img id="thumb" class="thumb" alt="미리보기" style="display:none">
  </div>

  <label for="prompt">프롬프트</label>
  <textarea id="prompt">(예시) 캐릭터 다른 포즈, SD풍, 1:1</textarea>

  <!-- Gen-Z 모드 -->
  <div class="row">
    <button id="genz-e" class="btn">e→3</button>
    <button id="genz-g" class="btn">g→8</button>
    <button id="genz-l" class="btn">l→1</button>
    <button id="genz-s" class="btn">s→5</button>
    <button id="genz-o" class="btn">o→0</button>
    <button id="genz-a" class="btn">a→4</button>
    <button id="genz-reset" class="btn">처음으로</button>
  </div>

  <fieldset>
    <legend>안전 설정</legend>
    <div class="grid">
      <label class="slab">Harassment <select id="s-HARASSMENT"></select></label>
      <label class="slab">Hate speech <select id="s-HATE_SPEECH"></select></label>
      <label class="slab">Sexual <select id="s-SEXUALLY_EXPLICIT"></select></label>
      <label class="slab">Dangerous <select id="s-DANGEROUS_CONTENT"></select></label>
      <label class="slab">Civic <select id="s-CIVIC_INTEGRITY"></select></label>
    </div>
  </fieldset>

  <div class="row">
    <button id="go" class="btn">이미지 만들기</button>
    <button id="save" class="btn" disabled>저장</button>
    <button id="copyB64" class="btn" disabled>Base64</button>
    <button id="openDataUrl" class="btn" disabled>새 탭</button>
    <span id="spin" style="display:none">⏳</span>
  </div>

  <div id="viewer"><div style="color:#888">아직 결과 없음</div></div>

  <label for="b64">Base64</label>
  <textarea id="b64" readonly></textarea>

  <label for="raw">원시 응답(raw)</label>
  <textarea id="raw" readonly></textarea>

  <div id="msg"></div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const refs = {
    endpoint: $('endpoint'), token: $('token'),
    file: $('file'), thumb: $('thumb'), shrink: $('shrink'),
    prompt: $('prompt'),
    go: $('go'), save: $('save'), copyB64: $('copyB64'), openDataUrl: $('openDataUrl'),
    spin: $('spin'), viewer: $('viewer'), b64: $('b64'), raw: $('raw'), msg: $('msg'),
    s: {
      HARASSMENT: $('s-HARASSMENT'), HATE_SPEECH: $('s-HATE_SPEECH'),
      SEXUALLY_EXPLICIT: $('s-SEXUALLY_EXPLICIT'), DANGEROUS_CONTENT: $('s-DANGEROUS_CONTENT'),
      CIVIC_INTEGRITY: $('s-CIVIC_INTEGRITY'),
    },
    genz: {
      e: $('genz-e'), g: $('genz-g'), l: $('genz-l'),
      s: $('genz-s'), o: $('genz-o'), a: $('genz-a'), reset: $('genz-reset')
    }
  };

  const SAFETY_OPTIONS = [
    ["", "기본"], ["OFF", "OFF"], ["BLOCK_ONLY_HIGH", "HIGH↑"],
    ["BLOCK_MEDIUM_AND_ABOVE", "MED↑"], ["BLOCK_LOW_AND_ABOVE", "LOW↑"],
    ["HARM_BLOCK_THRESHOLD_UNSPECIFIED", "미지정"]
  ];
  Object.values(refs.s).forEach(sel=>{
    sel.innerHTML = SAFETY_OPTIONS.map(([v,l])=>`<option value="${v}">${l}</option>`).join('');
    sel.value = "OFF";
  });

  // Gen-Z 변환
  let genzOriginal = null;
  function ensureOriginal(){ if(genzOriginal===null) genzOriginal=refs.prompt.value; }
  function applyGenZ(map){ ensureOriginal(); refs.prompt.value = map(refs.prompt.value); }
  refs.genz.e.onclick=()=>applyGenZ(s=>s.replace(/e/g,"3"));
  refs.genz.g.onclick=()=>applyGenZ(s=>s.replace(/g/g,"8"));
  refs.genz.l.onclick=()=>applyGenZ(s=>s.replace(/l/g,"1"));
  refs.genz.s.onclick=()=>applyGenZ(s=>s.replace(/s/g,"5"));
  refs.genz.o.onclick=()=>applyGenZ(s=>s.replace(/o/g,"0"));
  refs.genz.a.onclick=()=>applyGenZ(s=>s.replace(/a/g,"4"));
  refs.genz.reset.onclick=()=>{ if(genzOriginal!==null){ refs.prompt.value=genzOriginal; genzOriginal=null;} };

  function setBusy(b){ refs.spin.style.display=b?'inline':'none'; refs.go.disabled=b; }
  function setMsg(t,e){ refs.msg.textContent=t||''; refs.msg.style.color=e?'#c00':'#666'; }
  function showImage(b64,mime){ refs.viewer.innerHTML=''; const img=new Image(); img.src=`data:${mime};base64,${b64}`; refs.viewer.appendChild(img); }
  function base64FromFile(file){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>{const m=String(fr.result).match(/^data:(.+);base64,(.*)$/);if(!m)return rej("parse");res({mime:m[1],base64:m[2]});};
      fr.onerror=()=>rej(fr.error); fr.readAsDataURL(file);
    });
  }
  async function base64FromFileResized(file,max=512){
    const url=URL.createObjectURL(file);
    const img=await new Promise((res,rej)=>{const im=new Image();im.onload=()=>res(im);im.onerror=()=>rej("load");im.src=url;});
    const w=img.width,h=img.height,sc=Math.min(1,max/Math.max(w,h));
    const canvas=document.createElement('canvas');canvas.width=w*sc;canvas.height=h*sc;
    canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
    const dataUrl=canvas.toDataURL(file.type.includes('png')?'image/png':'image/jpeg',0.9);
    URL.revokeObjectURL(url);
    const m=dataUrl.match(/^data:(.+);base64,(.*)$/);return{mime:m[1],base64:m[2]};
  }
  function download(b64,mime){
    const bin=atob(b64),arr=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);
    const url=URL.createObjectURL(new Blob([arr],{type:mime}));
    const a=document.createElement('a');a.href=url;a.download=`gemini-${Date.now()}.png`;a.click();
    URL.revokeObjectURL(url);
  }

  refs.file.onchange=e=>{
    const f=e.target.files?.[0];if(!f)return;
    refs.thumb.src=URL.createObjectURL(f);refs.thumb.style.display='inline';
  };

  refs.go.onclick=async()=>{
    try{
      setMsg(''); setBusy(true);
      let image;
      if(refs.file.files[0]){
        image=refs.shrink.checked?await base64FromFileResized(refs.file.files[0]):await base64FromFile(refs.file.files[0]);
      }
      const safety={};Object.entries(refs.s).forEach(([k,sel])=>{if(sel.value)safety[k]=sel.value;});
      const headers={'Content-Type':'application/json'};if(refs.token.value.trim())headers['Authorization']='Bearer '+refs.token.value.trim();
      const body={prompt:refs.prompt.value,image,safety:Object.keys(safety).length?safety:undefined};
      const r=await fetch(refs.endpoint.value,{method:'POST',headers,body:JSON.stringify(body)});const j=await r.json();
      refs.raw.value=j.raw?JSON.stringify(j.raw,null,2):''; 
      if(j.image_base64){refs.b64.value=j.image_base64;showImage(j.image_base64,j.mime_type||'image/png');refs.save.disabled=false;refs.copyB64.disabled=false;refs.openDataUrl.disabled=false;setMsg('완료!');}
      else{refs.b64.value='';setMsg('실패: '+(j.error||''),true);}
    }catch(err){setMsg('오류: '+err,true);}finally{setBusy(false);}
  };
  refs.save.onclick=()=>{if(refs.b64.value)download(refs.b64.value,'image/png');};
  refs.copyB64.onclick=()=>{if(refs.b64.value)navigator.clipboard.writeText(refs.b64.value);};
  refs.openDataUrl.onclick=()=>{if(refs.b64.value)window.open(`data:image/png;base64,${refs.b64.value}`,'_blank');};
})();
</script>
</body>
</html>
