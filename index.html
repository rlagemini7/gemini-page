<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gemini ì´ë¯¸ì§€ ìƒì„±ê¸° (ì°¸ê³  + ì•ˆì „ì„¤ì •)</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --b:#ddd; }
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--fg); background:var(--bg); max-width:960px;margin:auto;padding:16px}
  h2{margin:.2rem 0 1rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0}
  .btn, select, input[type="text"]{padding:.6rem .9rem;border:1px solid var(--b);border-radius:10px;background:#fff;color:#000}
  .btn{cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:default}
  #viewer{border:1px solid var(--b);border-radius:10px;min-height:240px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  #viewer img{max-width:100%;max-height:70vh}
  textarea{width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  #prompt{min-height:110px} #b64{min-height:140px} #raw{min-height:220px}
  #msg{white-space:pre-wrap;color:var(--muted)}
  .thumb{max-height:120px;border:1px solid var(--b);border-radius:8px}
  fieldset{border:1px solid var(--b);border-radius:12px;padding:10px}
  legend{padding:0 6px;color:#333}
  label.slab{display:flex;gap:8px;align-items:center;min-width:260px;justify-content:space-between}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px}
</style>
<body>
  <h2>Gemini ì´ë¯¸ì§€ ìƒì„±ê¸°</h2>

  <div class="row">
    <input id="endpoint" type="text" placeholder="https://<Cloud-Run-URL>" style="flex:2;min-width:260px">
    <input id="token" type="text" placeholder="(ì„ íƒ) Bearer í† í°" style="flex:1;min-width:200px">
  </div>

  <div class="row">
    <input id="file" type="file" accept="image/*" class="btn">
    <img id="thumb" class="thumb" alt="ë¯¸ë¦¬ë³´ê¸°" style="display:none">
  </div>

  <label>í”„ë¡¬í”„íŠ¸</label>
  <textarea id="prompt">(ì„ íƒ) ì°¸ê³  ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°™ì€ ìºë¦­í„°ì˜ ë‹¤ë¥¸ í¬ì¦ˆë¥¼ SDí’ ë§Œí™” ìŠ¤íƒ€ì¼ë¡œ. 1:1.</textarea>

  <fieldset>
    <legend>ì•ˆì „ ì„¤ì • (ì¹´í…Œê³ ë¦¬ë³„)</legend>
    <div class="grid">
      <label class="slab">Harassment
        <select id="s-HARASSMENT"></select>
      </label>
      <label class="slab">Hate speech
        <select id="s-HATE_SPEECH"></select>
      </label>
      <label class="slab">Sexually explicit
        <select id="s-SEXUALLY_EXPLICIT"></select>
      </label>
      <label class="slab">Dangerous content
        <select id="s-DANGEROUS_CONTENT"></select>
      </label>
      <label class="slab">Civic integrity
        <select id="s-CIVIC_INTEGRITY"></select>
      </label>
    </div>
    <div style="margin-top:.5rem;color:#666;font-size:.9rem">
      ê¸°ë³¸ê°’: <b>OFF (gemini-2.5-flash ì´í›„)</b>, â€œê¸°ë³¸(ëª¨ë¸ ê¸°ë³¸ê°’)â€ì„ ê³ ë¥´ë©´ í•´ë‹¹ í•­ëª©ì€ ìš”ì²­ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤. î¨7î¨‚
    </div>
  </fieldset>

  <div class="row">
    <button id="go" class="btn">ğŸ¨ ì´ë¯¸ì§€ ë§Œë“¤ê¸°</button>
    <button id="save" class="btn" disabled>ğŸ“¥ íœ´ëŒ€í°ì— ì €ì¥</button>
    <button id="copyB64" class="btn" disabled>ğŸ“‹ Base64 ë³µì‚¬</button>
    <button id="copyDataUrl" class="btn" disabled>ğŸ”— data URL ë³µì‚¬</button>
    <button id="openDataUrl" class="btn" disabled>ğŸŒ ìƒˆ íƒ­ ì—´ê¸°</button>
    <span id="spin" style="display:none">â³ ìƒì„± ì¤‘â€¦</span>
  </div>

  <div id="viewer"><div style="color:#888">ì•„ì§ ê²°ê³¼ ì—†ìŒ</div></div>

  <label>Base64 ì›ë¬¸</label>
  <textarea id="b64" readonly></textarea>

  <label>ì›ì‹œ ì‘ë‹µ(raw) â€” ì•ˆì „ í”¼ë“œë°± í¬í•¨</label>
  <textarea id="raw" readonly></textarea>

  <div id="msg"></div>

<script>
const DEFAULTS = {
  ENDPOINT: "https://<Cloud-Run-URL>", // ì—¬ê¸°ì— ê¸°ë³¸ê°’ ì ì–´ë‘ë©´ í¸í•´ìš”
  BEARER_TOKEN: ""
};

// Safety ì˜µì…˜ë“¤(enum ê·¸ëŒ€ë¡œ). ì¼ë¶€ ëª¨ë¸/ë²„ì „ì—ì„œ BLOCK_NONEì€ ì œí•œë¨(ê¶Œì¥: OFF).
const SAFETY_OPTIONS = [
  ["", "ê¸°ë³¸(ëª¨ë¸ ê¸°ë³¸ê°’)"],
  ["OFF", "OFF (ê¶Œì¥/ê¸°ë³¸)"],
  ["BLOCK_ONLY_HIGH", "Block only HIGH"],
  ["BLOCK_MEDIUM_AND_ABOVE", "Block MEDIUM+ "],
  ["BLOCK_LOW_AND_ABOVE", "Block LOW+"],
  ["HARM_BLOCK_THRESHOLD_UNSPECIFIED", "Unspecified (ëª¨ë¸ ê¸°ë³¸ í•´ì„)"]
  // ["BLOCK_NONE", "BLOCK_NONE (ì¼ë¶€ GA ì œí•œ)"],
];

const CATS = ["HARASSMENT","HATE_SPEECH","SEXUALLY_EXPLICIT","DANGEROUS_CONTENT","CIVIC_INTEGRITY"];

function fillSelects() {
  for (const c of CATS) {
    const sel = document.getElementById("s-"+c);
    sel.innerHTML = SAFETY_OPTIONS.map(([v, label]) =>
      `<option value="${v}">${label}</option>`).join("");
    // ê¸°ë³¸ OFFë¡œ ì„¸íŒ…(ë¬¸ì„œ: 2.5-flash ì´í›„ ê¸°ë³¸ OFF). í•„ìš”ì‹œ ""ë¡œ ë°”ê¾¸ë©´ ëª¨ë¸ ê¸°ë³¸ ì‚¬ìš©.
    sel.value = "OFF";
  }
}

let last = { base64:null, mime:"image/png" };
function setBusy(b){ spin.style.display=b?'inline':'none'; go.disabled=b; }
function setMsg(t,err){ msg.textContent=t||''; msg.style.color = err ? '#c00' : '#666'; }
function showImage(b64,mime){ viewer.innerHTML=''; const img=new Image(); img.src=`data:${mime};base64,${b64}`; img.onload=()=>viewer.appendChild(img); }
function base64FromFile(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>{ const m=String(fr.result).match(/^data:(.+);base64,(.*)$/); if(!m) return reject(new Error("Base64 parse failed")); resolve({mime:m[1],base64:m[2]});}; fr.onerror=()=>reject(fr.error||new Error("FileReader error")); fr.readAsDataURL(file); }); }
function enableActions(on){ [save,copyB64,copyDataUrl,openDataUrl].forEach(el=>el.disabled=!on); }
function download(b64,mime){ const bin=atob(b64), bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); const blob=new Blob([bytes],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); const ts=new Date().toISOString().replace(/[:.]/g,'-'); const ext=mime.includes('png')?'png':(mime.includes('jpeg')?'jpg':'png'); a.href=url; a.download=`gemini-${ts}.${ext}`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),30000); setTimeout(()=>{ const url2=URL.createObjectURL(blob); window.open(url2,'_blank'); setTimeout(()=>URL.revokeObjectURL(url2),30000);},400); }

endpoint.value = DEFAULTS.ENDPOINT; token.value = DEFAULTS.BEARER_TOKEN; fillSelects();

file.onchange = (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); thumb.src=url; thumb.style.display='inline'; };

go.onclick = async ()=>{
  setMsg(''); enableActions(false);
  if (!/^https?:\/\//i.test(endpoint.value.trim())) return setMsg('ì—”ë“œí¬ì¸íŠ¸ URLì„ ì…ë ¥í•˜ì„¸ìš”.', true);
  if (!prompt.value.trim()) return setMsg('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);

  setBusy(true);
  try {
    let image;
    if (file.files?.[0]) image = await base64FromFile(file.files[0]);

    // safety ê°ì²´ ë§Œë“¤ê¸°: ""(ê¸°ë³¸) ì„ íƒì€ ë¹¼ê³ , ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ë³´ëƒ„
    const safety = {};
    for (const c of CATS) {
      const val = document.getElementById("s-"+c).value;
      if (val) safety[c] = val;
    }
    if (Object.keys(safety).length === 0) delete safety; // ëª¨ë‘ ê¸°ë³¸ì´ë©´ í†µì§¸ë¡œ ìƒëµ

    const headers = {'Content-Type':'application/json'};
    if (token.value.trim()) headers['Authorization'] = 'Bearer ' + token.value.trim();

    const res = await fetch(endpoint.value.trim(), {
      method:'POST',
      headers,
      body: JSON.stringify({ prompt: prompt.value.trim(), image, safety })
    });
    const j = await res.json();

    raw.value = j.raw ? JSON.stringify(j.raw, null, 2) : '';

    if (j.image_base64) {
      last = { base64: j.image_base64, mime: j.mime_type || 'image/png' };
      b64.value = last.base64;
      showImage(last.base64, last.mime);
      enableActions(true);
      setMsg('ì™„ë£Œ! ì €ì¥/ë³µì‚¬ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
    } else {
      b64.value = '';
      setMsg('ì´ë¯¸ì§€ê°€ ì˜¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' + (j.error ? `\nì—ëŸ¬: ${j.error}` : ''), true);
    }
  } catch (e) {
    setMsg(`í†µì‹  ì˜¤ë¥˜: ${e.message}`, true);
  } finally {
    setBusy(false);
  }
};

save.onclick = ()=>{ if(!last.base64) return; download(last.base64,last.mime); };
copyB64.onclick = async ()=>{ if(!last.base64) return; await navigator.clipboard.writeText(last.base64).catch(()=>{}); setMsg('Base64ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); };
copyDataUrl.onclick = async ()=>{ if(!last.base64) return; const url=`data:${last.mime};base64,${last.base64}`; await navigator.clipboard.writeText(url).catch(()=>{}); setMsg('data URLì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); };
openDataUrl.onclick = ()=>{ if(!last.base64) return; const url=`data:${last.mime};base64,${last.base64}`; const w=window.open(url,'_blank'); if(!w) setMsg('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆì–´ìš”. ë¸Œë¼ìš°ì € íŒì—… í—ˆìš©ì„ ì¼œì£¼ì„¸ìš”.', true); };
</script>
</body>
</html>
