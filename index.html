<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gemini 이미지 생성기 (안드로이드 + 연속생성 + 그리드 선택 보기/저장)</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --b:#ddd; --err:#c00; --hi:#06c; }
  body{font-family:system-ui, Roboto, Arial; color:var(--fg); background:var(--bg); max-width:980px;margin:auto;padding:16px}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0;align-items:center}
  .btn, select, input[type="text"]{padding:.6rem .9rem;border:1px solid var(--b);border-radius:10px;background:#fff;color:#000}
  .btn{cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:default}
  textarea{width:100%;font-family:monospace}
  #prompt{min-height:110px} #b64{min-height:140px} #raw{min-height:220px}
  .thumb{max-height:120px;border:1px solid var(--b);border-radius:8px}
  fieldset{border:1px solid var(--b);border-radius:12px;padding:10px}
  legend{padding:0 6px;color:#333}
  label.slab{display:flex;gap:8px;align-items:center;min-width:200px;justify-content:space-between}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
  .hint{font-size:.9rem;color:#666}
  #status { white-space:pre-wrap; max-width:420px }
  #status.err { color: var(--err); }
  #status.ok { color: var(--muted); }

  /* 미리보기(선택/최근 결과 크게) */
  #viewer{border:1px solid var(--b);border-radius:10px;min-height:240px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:.5rem}
  #viewer img{max-width:100%;max-height:70vh}

  /* 갤러리 */
  #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:8px}
  .card{position:relative;border:1px solid var(--b);border-radius:10px;overflow:hidden;background:#fff;cursor:pointer}
  .card img{display:block;width:100%;height:140px;object-fit:cover}
  .card .meta{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;font-size:.9rem}
  .badge{font-size:.75rem;color:#fff;background:var(--hi);padding:2px 6px;border-radius:999px}
  .card.sel{outline:2px solid var(--hi)}
</style>
<body>
  <h2>Gemini 이미지 생성기</h2>

  <div class="row">
    <input id="endpoint" type="text" placeholder="https://<Cloud-Run-URL>" style="flex:2;min-width:240px">
    <input id="token" type="text" placeholder="(선택) Bearer 토큰" style="flex:1;min-width:160px">
  </div>

  <div class="row">
    <input id="file" type="file" accept="image/*" class="btn">
    <label class="slab"><input id="shrink" type="checkbox"> 512px로 축소</label>
    <img id="thumb" class="thumb" alt="미리보기" style="display:none">
  </div>

  <label for="prompt">프롬프트</label>
  <textarea id="prompt">(예시) 캐릭터 다른 포즈, SD풍, 1:1</textarea>

  <!-- Gen-Z / 1337 -->
  <div class="row">
    <button id="genz-e" class="btn">e→3</button>
    <button id="genz-g" class="btn">g→8</button>
    <button id="genz-l" class="btn">l→1</button>
    <button id="genz-s" class="btn">s→5</button>
    <button id="genz-o" class="btn">o→0</button>
    <button id="genz-a" class="btn">a→4</button>
    <button id="genz-1337" class="btn">1337 변환</button>
    <button id="genz-reset" class="btn">처음으로</button>
  </div>

  <fieldset>
    <legend>안전 설정</legend>
    <div class="grid">
      <label class="slab">Harassment <select id="s-HARASSMENT"></select></label>
      <label class="slab">Hate speech <select id="s-HATE_SPEECH"></select></label>
      <label class="slab">Sexual <select id="s-SEXUALLY_EXPLICIT"></select></label>
      <label class="slab">Dangerous <select id="s-DANGEROUS_CONTENT"></select></label>
      <label class="slab">Civic <select id="s-CIVIC_INTEGRITY"></select></label>
    </div>
    <div class="hint">기본 OFF. “기본”을 고르면 해당 항목은 요청에서 제외됩니다.</div>
  </fieldset>

  <!-- 자동 재시도 옵션 -->
  <div class="row">
    <label class="slab">IMAGE_SAFETY 재시도
      <select id="retryImageSafety">
        <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
        <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
      </select>
    </label>
    <span class="hint">IMAGE_SAFETY일 때만 자동 재요청 (대기 1초)</span>
  </div>

  <!-- 연속생성 모드 -->
  <div class="row">
    <label class="slab"><input id="multiMode" type="checkbox"> 연속생성 모드</label>
    <label class="slab">장수
      <select id="multiCount">
        <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
        <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
      </select>
    </label>
    <span class="hint">ON이면 완료될 때까지 반복 생성</span>
  </div>

  <div class="row">
    <button id="go" class="btn">이미지 만들기</button>
    <button id="stop" class="btn" disabled>정지</button>
    <button id="save" class="btn" disabled>선택 저장</button>
    <button id="copyB64" class="btn" disabled>선택 Base64</button>
    <button id="openDataUrl" class="btn" disabled>선택 새 탭</button>
    <span id="spin" style="display:none">⏳ 생성 중</span>
    <span id="status" class=""></span>
  </div>

  <!-- RAW 먼저 -->
  <label for="raw">원시 응답(raw)</label>
  <textarea id="raw" readonly></textarea>

  <!-- 선택/최근 결과 크게 -->
  <div id="viewer"><div style="color:#888">아직 결과 없음</div></div>

  <!-- 갤러리 -->
  <div class="row">
    <strong>결과 그리드 (카드 탭하면 선택됨)</strong>
    <div style="flex:1"></div>
    <button id="clearGallery" class="btn">모두 지우기</button>
  </div>
  <div id="gallery"></div>

  <label for="b64">선택 항목 Base64</label>
  <textarea id="b64" readonly></textarea>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const refs = {
    endpoint: $('endpoint'), token: $('token'),
    file: $('file'), thumb: $('thumb'), shrink: $('shrink'),
    prompt: $('prompt'),
    go: $('go'), stop: $('stop'),
    save: $('save'), copyB64: $('copyB64'), openDataUrl: $('openDataUrl'),
    spin: $('spin'), status: $('status'),
    viewer: $('viewer'), b64: $('b64'), raw: $('raw'),
    retrySafetySel: $('retryImageSafety'),
    multiMode: $('multiMode'), multiCount: $('multiCount'),
    gallery: $('gallery'), clearGallery: $('clearGallery'),
    s: { HARASSMENT: $('s-HARASSMENT'), HATE_SPEECH: $('s-HATE_SPEECH'),
         SEXUALLY_EXPLICIT: $('s-SEXUALLY_EXPLICIT'), DANGEROUS_CONTENT: $('s-DANGEROUS_CONTENT'),
         CIVIC_INTEGRITY: $('s-CIVIC_INTEGRITY') },
    genz: { e:$('genz-e'), g:$('genz-g'), l:$('genz-l'), s:$('genz-s'), o:$('genz-o'), a:$('genz-a'),
            leet:$('genz-1337'), reset:$('genz-reset') }
  };

  // Safety 옵션
  const SAFETY_OPTIONS = [
    ["", "기본"], ["OFF", "OFF"], ["BLOCK_ONLY_HIGH", "HIGH↑"],
    ["BLOCK_MEDIUM_AND_ABOVE", "MED↑"], ["BLOCK_LOW_AND_ABOVE", "LOW↑"],
    ["HARM_BLOCK_THRESHOLD_UNSPECIFIED", "미지정"]
  ];
  Object.values(refs.s).forEach(sel=>{
    sel.innerHTML = SAFETY_OPTIONS.map(([v,l])=>`<option value="${v}">${l}</option>`).join('');
    sel.value = "OFF";
  });

  // ===== Gen-Z & 1337 =====
  let genzOriginal = null;
  function ensureOriginal(){ if(genzOriginal===null) genzOriginal=refs.prompt.value; }
  function applyGenZ(map){ ensureOriginal(); refs.prompt.value = map(refs.prompt.value); }
  refs.genz.e.onclick=()=>applyGenZ(s=>s.replace(/e/g,"3"));
  refs.genz.g.onclick=()=>applyGenZ(s=>s.replace(/g/g,"8"));
  refs.genz.l.onclick=()=>applyGenZ(s=>s.replace(/l/g,"1"));
  refs.genz.s.onclick=()=>applyGenZ(s=>s.replace(/s/g,"5"));
  refs.genz.o.onclick=()=>applyGenZ(s=>s.replace(/o/g,"0"));
  refs.genz.a.onclick=()=>applyGenZ(s=>s.replace(/a/g,"4"));
  function leet1337(str){ const m={a:'4',b:'8',e:'3',g:'6',i:'1',l:'1',o:'0',s:'5',t:'7',z:'2'}; return str.replace(/[ABEGILOSTZabegilostz]/g,ch=>m[ch.toLowerCase()]||ch); }
  refs.genz.leet.onclick = ()=> applyGenZ(leet1337);
  refs.genz.reset.onclick=()=>{ if(genzOriginal!==null){ refs.prompt.value=genzOriginal; genzOriginal=null; } };

  // ===== 상태/미리보기 =====
  function setStatus(text, kind){ refs.status.textContent = text || ''; refs.status.classList.remove('ok','err'); if (kind) refs.status.classList.add(kind); }
  function showInViewer(b64,mime){
    refs.viewer.innerHTML=''; const img=new Image(); img.src=`data:${mime||'image/png'};base64,${b64}`; refs.viewer.appendChild(img);
  }

  // 파일→Base64
  function base64FromFile(file){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>{const m=String(fr.result).match(/^data:(.+);base64,(.*)$/);if(!m)return rej("parse");res({mime:m[1],base64:m[2]});};
      fr.onerror=()=>rej(fr.error); fr.readAsDataURL(file);
    });
  }
  async function base64FromFileResized(file,max=512){
    const url=URL.createObjectURL(file);
    const img=await new Promise((res,rej)=>{const im=new Image();im.onload=()=>res(im);im.onerror=()=>rej("load");im.src=url;});
    const w=img.width,h=img.height,sc=Math.min(1,max/Math.max(w,h));
    const canvas=document.createElement('canvas');canvas.width=w*sc;canvas.height=h*sc;
    canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
    const dataUrl=canvas.toDataURL(file.type.includes('png')?'image/png':'image/jpeg',0.9);
    URL.revokeObjectURL(url);
    const m=dataUrl.match(/^data:(.+);base64,(.*)$/);return{mime:m[1],base64:m[2]};
  }

  // ===== 갤러리(단일 선택) =====
  const galleryItems = []; // {id, base64, mime, ts}
  let seq = 0;
  let currentSelectedId = null;

  function addToGallery(base64, mime){
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    const id = `${ts}-${(++seq)}`;
    galleryItems.unshift({ id, base64, mime: mime||'image/png', ts });
    // 새로 추가된 항목을 자동 선택
    setSelection(id);
    renderGallery();
  }

  function setSelection(id){
    currentSelectedId = id;
    const it = galleryItems.find(x=>x.id===id);
    if (it){
      showInViewer(it.base64, it.mime);
      refs.b64.value = it.base64;
      updateActionState(true);
    } else {
      refs.viewer.innerHTML = '<div style="color:#888">선택 없음</div>';
      refs.b64.value = '';
      updateActionState(false);
    }
    // 갤러리 외곽선 업데이트
    [...refs.gallery.querySelectorAll('.card')].forEach(card=>{
      card.classList.toggle('sel', card.getAttribute('data-id') === currentSelectedId);
    });
  }

  function renderGallery(){
    refs.gallery.innerHTML = galleryItems.map((it, idx) => `
      <div class="card ${it.id===currentSelectedId?'sel':''}" data-id="${it.id}" title="클릭해서 선택">
        <img src="data:${it.mime};base64,${it.base64}" alt="result ${idx+1}">
        <div class="meta">
          <span class="badge">#${idx+1}</span>
          <span style="color:#666;font-size:.8rem">${it.mime.includes('png')?'PNG':'JPG'}</span>
        </div>
      </div>
    `).join('');

    // 클릭 → 단일 선택 & 큰창 표시
    [...refs.gallery.querySelectorAll('.card')].forEach(card=>{
      card.addEventListener('click', ()=>{
        const id = card.getAttribute('data-id');
        setSelection(id);
      });
    });
  }

  function updateActionState(hasSel){
    refs.save.disabled = !hasSel;
    refs.copyB64.disabled = !hasSel;
    refs.openDataUrl.disabled = !hasSel;
  }

  refs.clearGallery.onclick = ()=>{
    galleryItems.splice(0, galleryItems.length);
    currentSelectedId = null;
    renderGallery();
    setSelection(null);
  };

  // 저장/복사/열기 (선택 항목 기준)
  function saveBase64(b64,mime, filename){
    const bin=atob(b64),arr=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);
    const blob=new Blob([arr],{type:mime||'image/png'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename || `gemini-${Date.now()}.${(mime||'image/png').includes('png')?'png':'jpg'}`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  refs.save.onclick=()=>{
    const it = galleryItems.find(x=>x.id===currentSelectedId);
    if(!it) return;
    const ext = it.mime.includes('png')?'png':(it.mime.includes('jpeg')?'jpg':'png');
    const filename = `gemini-${it.ts}.${ext}`;
    saveBase64(it.base64, it.mime, filename);
  };
  refs.copyB64.onclick=()=>{ const it=galleryItems.find(x=>x.id===currentSelectedId); if(it) navigator.clipboard.writeText(it.base64); };
  refs.openDataUrl.onclick=()=>{ const it=galleryItems.find(x=>x.id===currentSelectedId); if(it) window.open(`data:${it.mime};base64,${it.base64}`,'_blank'); };

  // ===== 요청/정지/자동재시도/연속생성 =====
  let currentController = null;
  let watchdogTimer = null;
  const WATCHDOG_MS = 120000; // 120초
  let stopRequested = false;

  let retryInternal = 0;
  let retrySafety = 0;
  let retryTotal = 0;
  const MAX_INTERNAL = 10;

  // 1초 대기
  const RETRY_DELAY_MS = 1000;
  const RETRY_DELAY_SEC = Math.round(RETRY_DELAY_MS/1000);

  function setBusy(isBusy){
    refs.spin.style.display = isBusy ? 'inline' : 'none';
    refs.go.disabled = isBusy;
    refs.stop.disabled = !isBusy;
    const disable = isBusy;
    [refs.save, refs.copyB64, refs.openDataUrl,
     refs.endpoint, refs.token, refs.file, refs.shrink,
     refs.prompt, refs.retrySafetySel, refs.multiMode, refs.multiCount, ...Object.values(refs.s),
     refs.genz.e, refs.genz.g, refs.genz.l, refs.genz.s, refs.genz.o, refs.genz.a, refs.genz.leet, refs.genz.reset,
     refs.clearGallery
    ].forEach(el => el.disabled = disable);
  }
  function clearWatchdog(){ if (watchdogTimer){ clearTimeout(watchdogTimer); watchdogTimer=null; } }
  function abortInFlight(reason='사용자 정지'){
    stopRequested = true;
    if (currentController){ currentController.abort(); currentController = null; }
    clearWatchdog();
    setBusy(false);
    setStatus(`요청 취소됨: ${reason}`,'ok');
    refs.go.textContent = '이미지 만들기';
  }

  refs.file.onchange=e=>{
    const f=e.target.files?.[0];if(!f)return;
    refs.thumb.src=URL.createObjectURL(f);refs.thumb.style.display='inline';
  };
  refs.stop.onclick=()=> abortInFlight('정지 버튼 클릭');

  function isInternalError(resp, json){
    const http500 = resp && resp.status === 500;
    const google500 = json && (json.googleStatus === 500 || json?.googleError?.code === 500);
    const internalTag = (json?.googleError?.status === 'INTERNAL') ||
                        (json?.error && typeof json.error === 'object' && json.error.status === 'INTERNAL') ||
                        (typeof json?.error === 'string' && json.error.includes('Internal error encountered')) ||
                        (json?.googleError?.message === 'Internal error encountered.') ||
                        (json?.error?.message === 'Internal error encountered.');
    return http500 || google500 || internalTag;
  }
  function isImageSafetyFailure(json){
    const c1 = Array.isArray(json?.raw?.candidates) ? json.raw.candidates : [];
    const c2 = Array.isArray(json?.candidates) ? json.candidates : [];
    const arr = c1.length ? c1 : c2;
    return arr.some(c => c?.finishReason === 'IMAGE_SAFETY');
  }

  async function doOneRequest(payload){
    currentController = new AbortController();
    const signal = currentController.signal;
    clearWatchdog();
    watchdogTimer = setTimeout(()=>abortInFlight('타임아웃'), WATCHDOG_MS);

    const headers={'Content-Type':'application/json'};
    const tok = refs.token.value.trim(); if (tok) headers['Authorization']='Bearer '+tok;

    try{
      const resp = await fetch(refs.endpoint.value,{ method:'POST', headers, body:JSON.stringify(payload), signal });
      const json = await resp.json().catch(()=>({ error:'JSON 파싱 실패' }));
      clearWatchdog(); currentController = null;

      // RAW 갱신
      refs.raw.value = json.raw ? JSON.stringify(json.raw, null, 2) : (json ? JSON.stringify(json, null, 2) : '');

      if(json.image_base64){
        // 갤러리에 넣고 자동 선택 → 미리보기/버튼 갱신
        addToGallery(json.image_base64, json.mime_type || 'image/png');
        retryTotal = retryTotal|0; // noop
        setStatus(`완료! (재시도 ${retryTotal}회)`, 'ok');
        return { ok:true };
      }

      if (isInternalError(resp, json)) return { ok:false, retryInternal:true, json };
      if (isImageSafetyFailure(json)) return { ok:false, retrySafety:true, json };

      const msg = '실패: ' + (json.error ? (typeof json.error==='string'? json.error : (json.error.message||'오류')) : `HTTP ${resp.status}`);
      setStatus(msg, 'err');
      return { ok:false, retryable:false, json };

    }catch(err){
      if (err.name === 'AbortError') return { ok:false, aborted:true };
      setStatus('오류: ' + err, 'err');
      return { ok:false, retryable:false };
    }finally{
      clearWatchdog();
      currentController = null;
    }
  }

  function delay(ms){
    return new Promise(async (resolve)=>{
      let waited=0;
      while(waited < ms && !stopRequested){ await new Promise(r=>setTimeout(r,200)); waited+=200; }
      resolve();
    });
  }

  refs.go.onclick = async ()=>{
    stopRequested = false;
    refs.go.textContent = '이미지 만들기';
    setStatus('', '');
    setBusy(true);

    try{
      // 입력 고정
      let image;
      if(refs.file.files[0]){
        image = refs.shrink.checked ? await base64FromFileResized(refs.file.files[0]) : await base64FromFile(refs.file.files[0]);
      }
      const safety={};Object.entries(refs.s).forEach(([k,sel])=>{if(sel.value)safety[k]=sel.value;});
      const basePayload={ prompt:refs.prompt.value, image, safety:Object.keys(safety).length?safety:undefined };

      const target = refs.multiMode.checked ? parseInt(refs.multiCount.value || '1', 10) : 1;
      let successSoFar = 0;
      refs.go.textContent = target>1 ? `이미지 만들기 (연속 0/${target})` : '이미지 만들기';

      while(!stopRequested && successSoFar < target){
        // 시도 단위 카운터 리셋
        retryInternal = 0; retrySafety = 0; retryTotal = 0;

        const payload = { ...basePayload };

        // 내부 재시도 루프
        while(true){
          if (stopRequested) break;

          const result = await doOneRequest(payload);
          if (result.ok){
            successSoFar++;
            setStatus(`완료! (재시도 ${retryTotal}회) • 연속 ${successSoFar}/${target}`, 'ok');
            refs.go.textContent = target>1 ? `이미지 만들기 (연속 ${successSoFar}/${target})` : '이미지 만들기';
            break; // 다음 장
          }

          if (result.aborted){ break; }

          // 서버 내부 오류
          if (result.retryInternal && retryInternal < 10){
            retryInternal++; retryTotal++;
            refs.go.textContent = target>1
              ? `이미지 만들기 (연속 ${successSoFar}/${target} · 서버 재시도 ${retryInternal}/10)`
              : `이미지 만들기 (서버 재시도 ${retryInternal}/10)`;
            setStatus(`서버 내부 오류… 1초 후 재시도 ${retryInternal}/10`, 'err');
            await delay(1000); continue;
          }

          // IMAGE_SAFETY
          const maxSafety = parseInt(refs.retrySafetySel.value || '0', 10);
          if (result.retrySafety && retrySafety < maxSafety){
            retrySafety++; retryTotal++;
            refs.go.textContent = target>1
              ? `이미지 만들기 (연속 ${successSoFar}/${target} · 안전 재시도 ${retrySafety}/${maxSafety})`
              : `이미지 만들기 (안전 재시도 ${retrySafety}/${maxSafety})`;
            setStatus(`IMAGE_SAFETY… 1초 후 재시도 ${retrySafety}/${maxSafety}`, 'err');
            await delay(1000); continue;
          }

          // 재시도 불가
          break;
        }

        if (!stopRequested && successSoFar < target){
          await delay(1000); // 다음 시도 전 짧은 간격
        }
      }
    }catch(e){
      setStatus('오류: '+e, 'err');
    }finally{
      setBusy(false);
      refs.go.textContent = '이미지 만들기';
      updateActionState(!!currentSelectedId);
    }
  };
})();
</script>
</body>
</html>
