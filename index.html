<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gemini ì´ë¯¸ì§€ ìƒì„±ê¸°</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --b:#ddd; }
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--fg); background:var(--bg); max-width:960px;margin:auto;padding:16px}
  h2{margin:.2rem 0 1rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0}
  .btn, select, input[type="text"]{padding:.6rem .9rem;border:1px solid var(--b);border-radius:10px;background:#fff;color:#000}
  .btn{cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:default}
  #viewer{border:1px solid var(--b);border-radius:10px;min-height:240px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  #viewer img{max-width:100%;max-height:70vh}
  textarea{width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  #prompt{min-height:110px} #b64{min-height:140px} #raw{min-height:220px}
  #msg{white-space:pre-wrap;color:var(--muted)}
  .thumb{max-height:120px;border:1px solid var(--b);border-radius:8px}
  fieldset{border:1px solid var(--b);border-radius:12px;padding:10px}
  legend{padding:0 6px;color:#333}
  label.slab{display:flex;gap:8px;align-items:center;min-width:260px;justify-content:space-between}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px}
  .err{color:#c00}
</style>
<body>
  <h2>Gemini ì´ë¯¸ì§€ ìƒì„±ê¸°</h2>

  <div class="row">
    <input id="endpoint" type="text" placeholder="https://gemini-image-198457492759.asia-northeast3.run.app" style="flex:2;min-width:260px">
    <input id="token" type="text" placeholder="(ì„ íƒ) Bearer í† í°" style="flex:1;min-width:200px">
  </div>

  <div class="row">
    <input id="file" type="file" accept="image/*" class="btn">
    <img id="thumb" class="thumb" alt="ë¯¸ë¦¬ë³´ê¸°" style="display:none">
  </div>

  <label for="prompt">í”„ë¡¬í”„íŠ¸</label>
  <textarea id="prompt">(ì„ íƒ) ì°¸ê³  ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°™ì€ ìºë¦­í„°ì˜ ë‹¤ë¥¸ í¬ì¦ˆë¥¼ SDí’ ë§Œí™” ìŠ¤íƒ€ì¼ë¡œ. 1:1.</textarea>

  <fieldset>
    <legend>ì•ˆì „ ì„¤ì • (ì¹´í…Œê³ ë¦¬ë³„)</legend>
    <div class="grid">
      <label class="slab">Harassment
        <select id="s-HARASSMENT"></select>
      </label>
      <label class="slab">Hate speech
        <select id="s-HATE_SPEECH"></select>
      </label>
      <label class="slab">Sexually explicit
        <select id="s-SEXUALLY_EXPLICIT"></select>
      </label>
      <label class="slab">Dangerous content
        <select id="s-DANGEROUS_CONTENT"></select>
      </label>
      <label class="slab">Civic integrity
        <select id="s-CIVIC_INTEGRITY"></select>
      </label>
    </div>
    <div style="margin-top:.5rem;color:#666;font-size:.9rem">
      ê¸°ë³¸ê°’: OFF. â€œê¸°ë³¸(ëª¨ë¸ ê¸°ë³¸ê°’)â€ì„ ê³ ë¥´ë©´ í•´ë‹¹ í•­ëª©ì€ ìš”ì²­ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
    </div>
  </fieldset>

  <div class="row">
    <button id="go" class="btn">ğŸ¨ ì´ë¯¸ì§€ ë§Œë“¤ê¸°</button>
    <button id="save" class="btn" disabled>ğŸ“¥ íœ´ëŒ€í°ì— ì €ì¥</button>
    <button id="copyB64" class="btn" disabled>ğŸ“‹ Base64 ë³µì‚¬</button>
    <button id="copyDataUrl" class="btn" disabled>ğŸ”— data URL ë³µì‚¬</button>
    <button id="openDataUrl" class="btn" disabled>ğŸŒ ìƒˆ íƒ­ ì—´ê¸°</button>
    <span id="spin" style="display:none">â³ ìƒì„± ì¤‘â€¦</span>
  </div>

  <div id="viewer"><div style="color:#888">ì•„ì§ ê²°ê³¼ ì—†ìŒ</div></div>

  <label for="b64">Base64 ì›ë¬¸</label>
  <textarea id="b64" readonly></textarea>

  <label for="raw">ì›ì‹œ ì‘ë‹µ(raw) â€” ì•ˆì „ í”¼ë“œë°± í¬í•¨</label>
  <textarea id="raw" readonly></textarea>

  <div id="msg"></div>

<script>
(function(){
  // ===== ì•ˆì „í•œ ìš”ì†Œ ì°¸ì¡° =====
  const $ = id => document.getElementById(id);
  const refs = {
    endpoint: $('endpoint'),
    token: $('token'),
    file: $('file'),
    thumb: $('thumb'),
    prompt: $('prompt'),
    go: $('go'),
    save: $('save'),
    copyB64: $('copyB64'),
    copyDataUrl: $('copyDataUrl'),
    openDataUrl: $('openDataUrl'),
    spin: $('spin'),
    viewer: $('viewer'),
    b64: $('b64'),
    raw: $('raw'),
    msg: $('msg'),
    s: {
      HARASSMENT: $('s-HARASSMENT'),
      HATE_SPEECH: $('s-HATE_SPEECH'),
      SEXUALLY_EXPLICIT: $('s-SEXUALLY_EXPLICIT'),
      DANGEROUS_CONTENT: $('s-DANGEROUS_CONTENT'),
      CIVIC_INTEGRITY: $('s-CIVIC_INTEGRITY'),
    }
  };

  // ===== ì´ˆê¸°ê°’(ì›í•˜ë©´ ë°”ê¿”ë‘ì„¸ìš”) =====
  const DEFAULTS = {
    ENDPOINT: "https://gemini-image-198457492759.asia-northeast3.run.app",
    BEARER_TOKEN: ""
  };
  refs.endpoint.value = DEFAULTS.ENDPOINT;
  refs.token.value = DEFAULTS.BEARER_TOKEN;

  // ===== Safety ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° =====
  const SAFETY_OPTIONS = [
    ["", "ê¸°ë³¸(ëª¨ë¸ ê¸°ë³¸ê°’)"],
    ["OFF", "OFF (ê¶Œì¥/ê¸°ë³¸)"],
    ["BLOCK_ONLY_HIGH", "Block only HIGH"],
    ["BLOCK_MEDIUM_AND_ABOVE", "Block MEDIUM+"],
    ["BLOCK_LOW_AND_ABOVE", "Block LOW+"],
    ["HARM_BLOCK_THRESHOLD_UNSPECIFIED", "Unspecified"]
  ];
  const CATS = Object.keys(refs.s);
  function fillSelect(sel){
    sel.innerHTML = SAFETY_OPTIONS.map(([v,l])=>`<option value="${v}">${l}</option>`).join('');
    sel.value = "OFF"; // ê¸°ë³¸ OFF
  }
  CATS.forEach(cat => fillSelect(refs.s[cat]));

  // ===== ìœ í‹¸ =====
  function setBusy(b){
    refs.spin.style.display = b ? 'inline' : 'none';
    refs.go.disabled = b;
  }
  function setMsg(text, isErr){
    refs.msg.textContent = text || '';
    refs.msg.classList.toggle('err', !!isErr);
    refs.msg.style.color = isErr ? '#c00' : '#666';
  }
  function showImage(b64, mime){
    refs.viewer.innerHTML = '';
    const img = new Image();
    img.src = `data:${mime};base64,${b64}`;
    img.onload = () => refs.viewer.appendChild(img);
  }
  function base64FromFile(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const m = String(fr.result).match(/^data:(.+);base64,(.*)$/);
        if (!m) return reject(new Error("Base64 parse failed"));
        resolve({ mime: m[1], base64: m[2] });
      };
      fr.onerror = () => reject(fr.error || new Error("FileReader error"));
      fr.readAsDataURL(file);
    });
  }
  function enableActions(on){
    [refs.save, refs.copyB64, refs.copyDataUrl, refs.openDataUrl].forEach(el => el.disabled = !on);
  }
  function download(b64,mime){
    const bin = atob(b64), bytes = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    const blob = new Blob([bytes],{type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    const ext = mime.includes('png')?'png':(mime.includes('jpeg')?'jpg':'png');
    a.href = url; a.download = `gemini-${ts}.${ext}`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),30000);
    // iOS ë³´ì™„
    setTimeout(()=>{
      const url2 = URL.createObjectURL(blob);
      window.open(url2, '_blank');
      setTimeout(()=>URL.revokeObjectURL(url2),30000);
    },400);
  }

  // ===== ì´ë²¤íŠ¸ =====
  refs.file.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    refs.thumb.src = url;
    refs.thumb.style.display = 'inline';
  });

  refs.go.addEventListener('click', async ()=>{
    try{
      setMsg(''); enableActions(false);

      const ENDPOINT = refs.endpoint.value.trim();
      if (!/^https?:\/\//i.test(ENDPOINT)) { setMsg('ì—”ë“œí¬ì¸íŠ¸ URLì„ ì…ë ¥í•˜ì„¸ìš”.', true); return; }
      const prompt = refs.prompt.value.trim();
      if (!prompt) { setMsg('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true); return; }

      setBusy(true);

      let image;
      if (refs.file.files?.[0]) image = await base64FromFile(refs.file.files[0]);

      // safety: ""ëŠ” ì œì™¸
      const safety = {};
      CATS.forEach(cat => {
        const v = refs.s[cat].value;
        if (v) safety[cat] = v;
      });
      if (Object.keys(safety).length === 0) undefined; // ëª¨ë‘ ê¸°ë³¸ì´ë©´ ì•ˆ ë³´ëƒ„

      const headers = { 'Content-Type': 'application/json' };
      const tok = refs.token.value.trim();
      if (tok) headers['Authorization'] = 'Bearer ' + tok;

      const body = JSON.stringify({ prompt, image, safety: (Object.keys(safety).length? safety: undefined) });

      const res = await fetch(ENDPOINT, { method:'POST', headers, body });
      let j;
      try { j = await res.json(); }
      catch { setMsg('ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨', true); return; }

      refs.raw.value = j.raw ? JSON.stringify(j.raw, null, 2) : '';

      if (j.image_base64) {
        refs.b64.value = j.image_base64;
        showImage(j.image_base64, j.mime_type || 'image/png');
        enableActions(true);
        setMsg('ì™„ë£Œ! ì €ì¥/ë³µì‚¬ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
      } else {
        refs.b64.value = '';
        setMsg('ì´ë¯¸ì§€ê°€ ì˜¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' + (j.error ? `\nì—ëŸ¬: ${j.error}` : ''), true);
      }
    } catch(err){
      setMsg(`ì˜¤ë¥˜: ${err.message}`, true);
    } finally {
      setBusy(false);
    }
  });

  refs.save.addEventListener('click', ()=>{ if (refs.b64.value) download(refs.b64.value, 'image/png'); });
  refs.copyB64.addEventListener('click', async ()=>{ if (!refs.b64.value) return; await navigator.clipboard.writeText(refs.b64.value).catch(()=>{}); setMsg('Base64ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); });
  refs.copyDataUrl.addEventListener('click', async ()=>{ if (!refs.b64.value) return; const url=`data:image/png;base64,${refs.b64.value}`; await navigator.clipboard.writeText(url).catch(()=>{}); setMsg('data URLì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); });
  refs.openDataUrl.addEventListener('click', ()=>{ if (!refs.b64.value) return; const url=`data:image/png;base64,${refs.b64.value}`; const w=window.open(url,'_blank'); if(!w) setMsg('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆì–´ìš”. ë¸Œë¼ìš°ì € íŒì—… í—ˆìš©ì„ ì¼œì£¼ì„¸ìš”.', true); });

  // ===== ê°„ë‹¨ ìê°€ ì§„ë‹¨(ì´ˆê¸° ì—ëŸ¬ ì¡ê¸°) =====
  window.addEventListener('error', e => setMsg('ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬: ' + e.message, true));
  window.addEventListener('unhandledrejection', e => setMsg('ë¹„ë™ê¸° ì—ëŸ¬: ' + (e.reason?.message || e.reason), true));
})();
</script>
</body>
</html>
