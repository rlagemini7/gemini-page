<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gemini ì´ë¯¸ì§€ ìƒì„±ê¸° (ì°¸ê³  ì´ë¯¸ì§€ + ì•ˆì „í”¼ë“œë°±)</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --b:#ddd; }
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
       color:var(--fg); background:var(--bg);
       max-width:920px;margin:auto;padding:16px}
  h2{margin:.2rem 0 1rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0}
  .btn{padding:.6rem .95rem;border:1px solid var(--b);border-radius:10px;background:#fff;color:#000;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:default}
  #viewer{border:1px solid var(--b);border-radius:10px;min-height:240px;
          display:flex;align-items:center;justify-content:center;overflow:hidden}
  #viewer img{max-width:100%;max-height:70vh}
  textarea{width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  #prompt{min-height:110px}
  #b64{min-height:140px}
  #raw{min-height:220px}
  #msg{white-space:pre-wrap;color:var(--muted)}
  .thumb{max-height:120px;border:1px solid var(--b);border-radius:8px}
  .hint{font-size:.9rem;color:var(--muted)}
  .cfg{font-size:.9rem;color:#333;background:#fafafa;border:1px dashed var(--b);border-radius:10px;padding:.6rem}
  label{font-weight:600;display:block;margin-top:10px;margin-bottom:6px}
</style>
<body>
  <h2>Gemini ì´ë¯¸ì§€ ìƒì„±ê¸°</h2>

  <div class="cfg">
    <div class="hint">ì•„ë˜ ë‘ ê°’ë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.</div>
    <div><strong>ENDPOINT</strong> = Cloud Run ê³µê°œ URL</div>
    <div><strong>BEARER_TOKEN</strong> (ì„ íƒ) = ì„œë²„ê°€ í† í°ì„ ìš”êµ¬í•˜ëŠ” ê²½ìš°</div>
  </div>

  <div class="row" style="margin-top:10px">
    <label for="endpoint" style="margin:0">ì—”ë“œí¬ì¸íŠ¸</label>
    <input id="endpoint" class="btn" style="flex:1;min-width:260px" placeholder="https://<your-cloud-run-url>">
    <input id="token" class="btn" style="flex:1;min-width:200px" placeholder="(ì„ íƒ) Bearer í† í°">
  </div>

  <div class="row">
    <input id="file" type="file" accept="image/*" class="btn">
    <img id="thumb" class="thumb" alt="ë¯¸ë¦¬ë³´ê¸°" style="display:none">
  </div>

  <label>í”„ë¡¬í”„íŠ¸</label>
  <textarea id="prompt">(ì„ íƒ) ì°¸ê³  ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°™ì€ ìºë¦­í„°ì˜ ë‹¤ë¥¸ í¬ì¦ˆë¥¼ SDí’ ë§Œí™” ìŠ¤íƒ€ì¼ë¡œ. 1:1.</textarea>

  <div class="row">
    <button id="go" class="btn">ğŸ¨ ì´ë¯¸ì§€ ë§Œë“¤ê¸°</button>
    <button id="save" class="btn" disabled>ğŸ“¥ íœ´ëŒ€í°ì— ì €ì¥</button>
    <button id="copyB64" class="btn" disabled>ğŸ“‹ Base64 ë³µì‚¬</button>
    <button id="copyDataUrl" class="btn" disabled>ğŸ”— data URL ë³µì‚¬</button>
    <button id="openDataUrl" class="btn" disabled>ğŸŒ ìƒˆ íƒ­ ì—´ê¸°</button>
    <span id="spin" style="display:none">â³ ìƒì„± ì¤‘â€¦</span>
  </div>

  <div id="viewer"><div style="color:#888">ì•„ì§ ê²°ê³¼ ì—†ìŒ</div></div>

  <label>Base64 ì›ë¬¸</label>
  <textarea id="b64" placeholder="ì—¬ê¸°ì— base64ê°€ í‘œì‹œë©ë‹ˆë‹¤" readonly></textarea>

  <label>ì›ì‹œ ì‘ë‹µ(raw) â€” ì•ˆì „ í”¼ë“œë°± í¬í•¨</label>
  <textarea id="raw" placeholder="j.raw ì „ì²´ê°€ í‘œì‹œë©ë‹ˆë‹¤" readonly></textarea>

  <div id="msg"></div>

<script>
/* ===== ì‚¬ìš©ì ì„¤ì • (ì´ˆê¸°ê°’) ===== */
const DEFAULTS = {
  ENDPOINT: "https://<ì—¬ê¸°ì—-Cloud-Run-URL>", // â† ë°°í¬ URLë¡œ êµì²´
  BEARER_TOKEN: "" // ì„œë²„ê°€ Authorization: Bearer ê²€ì¦í•˜ë©´ ë„£ìœ¼ì„¸ìš”
};
/* ================================= */

let last = { base64:null, mime:"image/png" };

function setBusy(b){
  document.getElementById('spin').style.display=b?'inline':'none';
  document.getElementById('go').disabled=b;
}
function setMsg(t, err){
  const m=document.getElementById('msg');
  m.textContent=t||''; m.style.color = err ? '#c00' : '#666';
}
function showImage(b64, mime){
  const v = document.getElementById('viewer');
  v.innerHTML = '';
  const img = new Image();
  img.src = `data:${mime};base64,${b64}`;
  img.onload = ()=> v.appendChild(img);
}
function base64FromFile(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => {
      const res = fr.result; // data:<mime>;base64,XXXX
      const m = String(res).match(/^data:(.+);base64,(.*)$/);
      if (!m) return reject(new Error("Base64 parse failed"));
      resolve({ mime: m[1], base64: m[2] });
    };
    fr.onerror = () => reject(fr.error || new Error("FileReader error"));
    fr.readAsDataURL(file);
  });
}
function enableActions(on){
  ['save','copyB64','copyDataUrl','openDataUrl'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = !on;
  });
}
function download(b64,mime){
  const bin = atob(b64), len = bin.length, bytes = new Uint8Array(len);
  for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
  const blob = new Blob([bytes], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  const ext = mime.includes('png')?'png':(mime.includes('jpeg')?'jpg':'png');
  a.href=url; a.download=`gemini-${ts}.${ext}`; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 30000);
  // iOS ë³´ì™„: ìƒˆ íƒ­ ì—´ì–´ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥
  setTimeout(()=>{
    const url2 = URL.createObjectURL(blob);
    window.open(url2, '_blank');
    setTimeout(()=>URL.revokeObjectURL(url2), 30000);
  }, 400);
}

document.getElementById('endpoint').value = DEFAULTS.ENDPOINT;
document.getElementById('token').value = DEFAULTS.BEARER_TOKEN;

document.getElementById('file').onchange = (e)=>{
  const f = e.target.files?.[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  const th = document.getElementById('thumb');
  th.src = url; th.style.display = 'inline';
};

document.getElementById('go').onclick = async () => {
  setMsg('');
  enableActions(false);

  const ENDPOINT = document.getElementById('endpoint').value.trim();
  const BEARER = document.getElementById('token').value.trim();
  if (!/^https?:\/\//i.test(ENDPOINT)) return setMsg('ì—”ë“œí¬ì¸íŠ¸ URLì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.', true);

  const f = document.getElementById('file').files?.[0];
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return setMsg('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);

  setBusy(true);
  try {
    let image = undefined;
    if (f) image = await base64FromFile(f);

    const headers = {'Content-Type':'application/json'};
    if (BEARER) headers['Authorization'] = 'Bearer ' + BEARER;

    const res = await fetch(ENDPOINT, {
      method:'POST',
      headers,
      body: JSON.stringify({ prompt, image })
    });

    const j = await res.json();

    // ì•ˆì „ í”¼ë“œë°± ë“± raw ì „ì²´ í‘œì‹œ
    document.getElementById('raw').value = j.raw ? JSON.stringify(j.raw, null, 2) : '';

    if (j.image_base64) {
      last = { base64: j.image_base64, mime: j.mime_type || 'image/png' };
      document.getElementById('b64').value = last.base64;
      showImage(last.base64, last.mime);
      enableActions(true);
      setMsg('ì™„ë£Œ! ì €ì¥/ë³µì‚¬ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
    } else {
      document.getElementById('b64').value = '';
      setMsg('ì´ë¯¸ì§€ê°€ ì˜¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' + (j.error ? `\nì—ëŸ¬: ${j.error}` : ''), true);
    }
  } catch (e) {
    setMsg(`í†µì‹  ì˜¤ë¥˜: ${e.message}`, true);
  } finally {
    setBusy(false);
  }
};

document.getElementById('save').onclick = ()=>{
  if (!last.base64) return;
  download(last.base64, last.mime);
};
document.getElementById('copyB64').onclick = async ()=>{
  if (!last.base64) return;
  await navigator.clipboard.writeText(last.base64).catch(()=>{});
  setMsg('Base64ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
};
document.getElementById('copyDataUrl').onclick = async ()=>{
  if (!last.base64) return;
  const url = `data:${last.mime};base64,${last.base64}`;
  await navigator.clipboard.writeText(url).catch(()=>{});
  setMsg('data URLì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
};
document.getElementById('openDataUrl').onclick = ()=>{
  if (!last.base64) return;
  const url = `data:${last.mime};base64,${last.base64}`;
  const w = window.open(url, '_blank');
  if (!w) setMsg('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆì–´ìš”. ë¸Œë¼ìš°ì € íŒì—… í—ˆìš©ì„ ì¼œì£¼ì„¸ìš”.', true);
};
</script>
</body>
</html>
